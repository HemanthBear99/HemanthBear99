name: Update README with Recent Work

# allow the workflow to write repo contents
permissions:
  contents: write

on:
  schedule:
    - cron: "0 0 * * *"   # runs once daily
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true   # ensure git uses GITHUB_TOKEN for push
          fetch-depth: 0

      - name: Fetch recent repositories
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            try {
              // 1. Fetch Repositories
              const { data: repos } = await github.rest.repos.listForUser({
                username: 'HemanthBear99',
                sort: 'updated',
                per_page: 5
              });

              // Helper to get description from README if missing
              async function getDynamicDescription(repo) {
                if (repo.description) return repo.description.replace(/\|/g, '\\|');
                try {
                  const { data: readme } = await github.rest.repos.getReadme({
                    owner: repo.owner.login,
                    repo: repo.name
                  });
                  const content = Buffer.from(readme.content, 'base64').toString('utf8');

                  // Robust cleanup to extract meaningful plain text
                  const cleanText = content
                    .replace(/^#+\s+.+$/gm, '')                    // Remove headers
                    .replace(/\[!\[.*?\]\(.*?\)\]\(.*?\)/g, '')     // Remove nested image links [![](img)](url)
                    .replace(/!\[.*?\]\(.*?\)/g, '')                 // Remove images ![](url)
                    .replace(/<[^>]*>/g, '')                         // Remove HTML tags
                    .replace(/\[([^\]]+)\]\(.*?\)/g, '$1')           // Remove links, keep text
                    .replace(/\*{1,2}([^*]+)\*{1,2}/g, '$1')        // Remove bold/italic **text**
                    .replace(/_{1,2}([^_]+)_{1,2}/g, '$1')           // Remove bold/italic __text__
                    .replace(/`([^`]+)`/g, '$1')                     // Remove inline code
                    .replace(/[^\x20-\x7E]/g, '')                    // Remove non-ASCII (emoji, garbled chars)
                    .replace(/\s+/g, ' ')                            // Collapse whitespace
                    .split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 20 && !line.startsWith('|') && !line.startsWith('-'))
                    .shift();

                  if (!cleanText || cleanText.trim().length < 10) return 'No description available';
                  return cleanText.substring(0, 80).replace(/\|/g, '\\|') + '...';
                } catch (e) {
                  return 'No description available';
                }
              }

              // Process repos in parallel
              const processedRepos = await Promise.all(repos.slice(0, 3).map(async (r) => {
                r.dynamicDescription = await getDynamicDescription(r);
                return r;
              }));

              const work = processedRepos
                .map(r => `<a href="${r.html_url}"><img src="https://github-readme-stats.vercel.app/api/pin/?username=HemanthBear99&repo=${r.name}&theme=radical&bg_color=0D1117&title_color=39FF14&icon_color=39FF14" height="120" /></a>`)
                .join(' ');

              const projectsTable = [
                '| Project | Description | Tech |',
                '|--------|-------------|------|',
                ...processedRepos.map(r =>
                  `| **${r.name}** | ${r.dynamicDescription} | ${r.language || 'â€”'} |`
                )
              ].join('\n');

              // 2. Fetch Recent Activity
              let recentActivity = 'No recent public activity found.';
              try {
                const { data: events } = await github.rest.activity.listPublicEventsForUser({
                  username: 'HemanthBear99',
                  per_page: 20
                });

                const activityLines = events
                  .filter(event => event.type === 'PushEvent' || event.type === 'CreateEvent')
                  .slice(0, 5)
                  .map(event => {
                    const repoName = event.repo.name.split('/')[1];
                    let action = '';
                    if (event.type === 'PushEvent') {
                      const commits = event.payload.commits || [];
                      const commitMsg = (commits[0] && commits[0].message)
                        ? commits[0].message.split('\n')[0]
                        : 'Pushed code';
                      action = `ðŸ”¨ Pushed to **${repoName}**: "${commitMsg}"`;
                    } else if (event.type === 'CreateEvent') {
                      action = `ðŸš€ Created new repository **${repoName}**`;
                    }
                    return `- ${action}`;
                  })
                  .join('\n');

                if (activityLines) recentActivity = activityLines;
              } catch (e) {
                core.warning(`Failed to fetch activity events: ${e.message}`);
              }

              // 3. Update README
              let readme = fs.readFileSync('README.md', 'utf8');

              readme = readme.replace(
                /<!-- CURRENT-WORK-START -->[\s\S]*?<!-- CURRENT-WORK-END -->/,
                `<!-- CURRENT-WORK-START -->\n${work}\n<!-- CURRENT-WORK-END -->`
              );

              readme = readme.replace(
                /<!-- PROJECTS-START -->[\s\S]*?<!-- PROJECTS-END -->/,
                `<!-- PROJECTS-START -->\n${projectsTable}\n<!-- PROJECTS-END -->`
              );

              readme = readme.replace(
                /<!-- ACTIVITY-START -->[\s\S]*?<!-- ACTIVITY-END -->/,
                `<!-- ACTIVITY-START -->\n${recentActivity}\n<!-- ACTIVITY-END -->`
              );

              fs.writeFileSync('README.md', readme);
            } catch (error) {
              core.setFailed(`Workflow failed: ${error.message}`);
            }

      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add README.md
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-update current work & projects"
            git push origin HEAD:${{ github.ref_name }}
          fi
